var Uploader=function(){var e="",r=1048576,a=2e3,t=0,n=0,o=0,d=0,i=r,l=null,s="",p=0,u=0,f=null,c=[],m={},v=!1,g=$("#absolute_url").val();$(function(){console.log("Advantage Transportation uploader"),e=$("#absolute_url").html(),v=$("#gallery_image_text").val(),$("body").on("click","#upload",function(e){e.stopPropagation(),e.preventDefault(),Uploader.prepRequest()})});var h=function(){console.log("in addFile"),$("#general-errors").hide().html(),$("#files").empty();for(var e=document.getElementById("file"),r=0;r<e.files.length;++r){var a=e.files.item(r).name,t='<div class="upload-elements" id="'+r+'">';t+='<div class="upload-filename"><span class="field-title">Filename:</span> '+a+"</div>",t+='<div class="upload-data">',v&&(t+='<div class="form-field">',t+='<div class="field-title">Summary:</div>',t+='<div class="field-value"><textarea name="summary" placeholder="Brief description of image"></textarea></div>',t+="</div>"),t+='<div class="progress-wrapper">',t+='<div class="progress-display">',t+='<div class="progress">0%</div>',t+="</div>",t+='<div class="upload-error"></div>',t+="</div>",t+="</div>",t+="</div>",$("#files").append(t),$("#upload").show()}},_=function(){if(console.log("in prep request "),"undefined"==typeof document.getElementById("file").files[u])return void $("#general-errors").html("Please choose a file to upload.").show();$("#frm :input, #frm textarea").attr("disabled",!0);var e=$(".upload-elements[id='"+u+"']");console.log("in prep request "+e);var t=$('<div class="file-prep-notice"><div class="prep-loader"></div><div class="prep-text">Prepping file for upload.</div></div>');e.find(".progress-display").append(t),t.fadeIn(200,function(){y(u),m[u]={},m[u].gallery_id=$("#gallery_id").val(),m[u].dom_id=u,m[u].blob=document.getElementById("file").files[u],m[u].SIZE=m[u].blob.size,m[u].name=m[u].blob.name,m[u].NUM_CHUNKS=Math.ceil(m[u].SIZE/(r-a))+1,m[u].CHUNK_INDEX=0,m[u].TOTAL_LOADED=0,m[u].start=0;var n=new FormData;n.append("current_index",m[u].dom_id),n.append("name",m[u].name),v&&n.append("summary",e.find("[name='summary']").val()),n.append("gallery-permalink",$("#gallery_permalink").val()),f=new XMLHttpRequest,f.addEventListener("load",function(r){var a=JSON.parse(r.target.response);"error"in a?T(e.find(".upload-error"),"There was an error attempting to upload the file: "+a.error):t.fadeOut(300,function(){$(this).remove(),E(m[u])})},!1),f.addEventListener("error",function(r){var a=JSON.parse(r.target.response);"error"in a?T(e.find(".upload-error"),"There was an error attempting to upload the file: "+a.error):console.log(r)},!1),f.addEventListener("abort",function(r){var a=JSON.parse(r.target.response);"error"in a?T(e.find(".upload-error"),"There was an error attempting to upload the file: "+a.error):console.log(r)},!1),console.log("call xhr post method "+$("#absolute_url").html()+"includes/fileupload/scripts/ajax-uploader/gallery/prep-file.php"),f.open("POST",g+"includes/fileupload/scripts/ajax-uploader/gallery/prep-file.php"),f.send(n)})},E=function(e){if(e.start<e.SIZE){i=e.CHUNK_INDEX?e.start+r:e.start+a,i>e.SIZE&&(i=e.SIZE);var t=e.blob.slice(e.start,i);N(t,e),e.start=i,e.CHUNK_INDEX++}},y=function(e){var r=document.getElementById("file").files[e];if(r){var a=0;a=r.size>1048576?(Math.round(100*r.size/1048576)/100).toString()+"MB":(Math.round(100*r.size/1024)/100).toString()+"KB"}},N=function(e,t){var n=new FormData;n.append("file",e),n.append("index",t.CHUNK_INDEX),n.append("current_index",t.dom_id),f=new XMLHttpRequest;var o=0,d=0;f.addEventListener("load",function(e){S(e,t)},!1),f.addEventListener("error",function(e){b(e,t)},!1),f.addEventListener("abort",function(e){w(e,t)},!1),f.open("POST",g+"includes/fileupload/scripts/ajax-uploader/gallery/uploadfile.php"),f.upload.onprogress=function(e){if(e.lengthComputable){var n=o;o=t.CHUNK_INDEX?e.loaded/e.total*r:e.loaded/e.total*a,t.TOTAL_LOADED=t.TOTAL_LOADED-n+o;var d=(100*t.TOTAL_LOADED/t.SIZE).toFixed(2);d>100&&(d=100);var i=$("#"+t.dom_id).find(".progress");i.html(d.toString()+"%"),i.addClass("active-progress"),i.css("width",i.html())}else $("#"+t.dom_id).find(".progress").html("unable to compute: "+N)},f.send(n)},S=function(e,r){var a=JSON.parse(e.target.response),t=$("#"+r.dom_id);if("error"in a)T(t.find(".upload-error"),"There was an error attempting to upload the file: "+a.error);else if(r.NUM_CHUNKS===r.CHUNK_INDEX){var n=$('<div class="file-prep-notice"><div class="prep-loader"></div><div class="prep-text">Uploaded file.  Merging.</div></div>');t.find(".progress-display").append(n),n.fadeIn(200,function(){L(r)})}else E(r)},b=function(e,r){e=JSON.data(e),$("#"+r.dom_id).find(".upload-error").html("There was an error attempting to upload the file: "+e.error).show()},w=function(e,r){f.abort(),f=null},L=function(e){f=new XMLHttpRequest;var r=new FormData;r.append("current_index",e.dom_id),r.append("name",e.name),r.append("index",e.NUM_CHUNKS),f.addEventListener("error",function(e){var r=JSON.parse(e.target.response);T("There was an error attempting to upload the file: "+r.error)}),f.addEventListener("load",function(r){var a=JSON.parse(r.target.response);"error"in a?T($("#"+e.dom_id).find(".upload-error"),"There was an error attempting to upload the file: "+a.error):($("#"+e.dom_id).find(".prep-text").html("Merged file.  Updating database."),O(e))}),f.open("POST",g+"includes/fileupload/scripts/ajax-uploader/gallery/merge.php",!0),f.send(r)},O=function(e){f=new XMLHttpRequest;var r=new FormData;r.append("current_index",e.dom_id),r.append("gallery_id",e.gallery_id),f.addEventListener("error",function(e){var r=JSON.parse(e.target.response);T("There was an error attempting to update the database: "+r.error)}),f.addEventListener("load",function(r){var a=JSON.parse(r.target.response);"error"in a?T($("#"+e.dom_id).find(".upload-error"),"There was an error attempting to update the database: "+a.error):($("#"+e.dom_id).find(".prep-loader").css("opacity","0"),$("#"+e.dom_id).find(".prep-text").html("Done!"),u++,document.getElementById("file").files.length>u?_():$("#frm").submit())}),f.open("POST",g+"includes/fileupload/scripts/ajax-uploader/gallery/updateDB.php",!0),f.send(r)},T=function(e,r){e.html(r).show(),e.siblings(".progress-display").find(".progress").addClass("error-progress")},x=function(e,r,a){$("#permalink_error").html(r+" - "+a)};return{addFile:h,prepRequest:_}}();