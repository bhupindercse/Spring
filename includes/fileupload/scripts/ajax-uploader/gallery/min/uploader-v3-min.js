var Uploader=function(){var e="",r=1048576,a=2e3,t=0,n=0,o=0,d=0,i=r,l=null,s="",p=0,u=0,f=null,m=[],c={},v=!1;$(function(){e=$("#absolute_url").html(),v=$("#gallery_image_text").val(),console.log("in uploader"),console.log("has_text= "+v),$("body").on("click","#upload",function(e){e.stopPropagation(),e.preventDefault(),Uploader.prepRequest()})});var g=function(){$("#general-errors").hide().html(),$("#files").empty();for(var e=document.getElementById("file"),r=0;r<e.files.length;++r){var a=e.files.item(r).name;console.log("in addFile method name = "+a),console.log("in addFile method name = "+full_path);var t='<div class="upload-elements" id="'+r+'">';t+='<div class="upload-filename"><span class="field-title">Filename:</span> '+a+"</div>",t+='<div class="upload-data">',v&&(t+='<div class="form-field">',t+='<div class="field-title">Summary:</div>',t+='<div class="field-value"><textarea name="summary" placeholder="Brief description of image"></textarea></div>',t+="</div>"),t+='<div class="progress-wrapper">',t+='<div class="progress-display">',t+='<div class="progress">0%</div>',t+="</div>",t+='<div class="upload-error"></div>',t+="</div>",t+="</div>",t+="</div>",$("#files").append(t),$("#upload").show()}},h=function(){if(console.log("in prep request "),"undefined"==typeof document.getElementById("file").files[u])return void $("#general-errors").html("Please choose a file to upload.").show();$("#frm :input, #frm textarea").attr("disabled",!0);var t=$(".upload-elements[id='"+u+"']"),n=$('<div class="file-prep-notice"><div class="prep-loader"></div><div class="prep-text">Prepping file for upload.</div></div>');t.find(".progress-display").append(n),n.fadeIn(200,function(){E(u),c[u]={},c[u].gallery_id=$("#gallery_id").val(),c[u].dom_id=u,c[u].blob=document.getElementById("file").files[u],c[u].SIZE=c[u].blob.size,c[u].name=c[u].blob.name,c[u].NUM_CHUNKS=Math.ceil(c[u].SIZE/(r-a))+1,c[u].CHUNK_INDEX=0,c[u].TOTAL_LOADED=0,c[u].start=0;var o=new FormData;o.append("current_index",c[u].dom_id),o.append("name",c[u].name),v&&o.append("summary",t.find("[name='summary']").val()),o.append("gallery-permalink",$("#gallery_permalink").val()),f=new XMLHttpRequest,f.addEventListener("load",function(e){var r=JSON.parse(e.target.response);"error"in r?b(t.find(".upload-error"),"There was an error attempting to upload the file: "+r.error):n.fadeOut(300,function(){$(this).remove(),_(c[u])})},!1),f.addEventListener("error",function(e){var r=JSON.parse(e.target.response);"error"in r?b(t.find(".upload-error"),"There was an error attempting to upload the file: "+r.error):console.log(e)},!1),f.addEventListener("abort",function(e){var r=JSON.parse(e.target.response);"error"in r?b(t.find(".upload-error"),"There was an error attempting to upload the file: "+r.error):console.log(e)},!1),f.open("POST",e+"includes/fileupload/scripts/ajax-uploader/gallery/prep-file.php"),f.send(o)})},_=function(e){if(e.start<e.SIZE){i=e.CHUNK_INDEX?e.start+r:e.start+a,i>e.SIZE&&(i=e.SIZE);var t=e.blob.slice(e.start,i);y(t,e),e.start=i,e.CHUNK_INDEX++}},E=function(e){var r=document.getElementById("file").files[e];if(r){var a=0;a=r.size>1048576?(Math.round(100*r.size/1048576)/100).toString()+"MB":(Math.round(100*r.size/1024)/100).toString()+"KB"}},y=function(t,n){var o=new FormData;o.append("file",t),o.append("index",n.CHUNK_INDEX),o.append("current_index",n.dom_id),f=new XMLHttpRequest;var d=0,i=0;f.addEventListener("load",function(e){N(e,n)},!1),f.addEventListener("error",function(e){S(e,n)},!1),f.addEventListener("abort",function(e){w(e,n)},!1),f.open("POST",e+"includes/fileupload/scripts/ajax-uploader/gallery/uploadfile.php"),f.upload.onprogress=function(e){if(e.lengthComputable){var t=d;d=n.CHUNK_INDEX?e.loaded/e.total*r:e.loaded/e.total*a,n.TOTAL_LOADED=n.TOTAL_LOADED-t+d;var o=(100*n.TOTAL_LOADED/n.SIZE).toFixed(2);o>100&&(o=100);var i=$("#"+n.dom_id).find(".progress");i.html(o.toString()+"%"),i.addClass("active-progress"),i.css("width",i.html())}else $("#"+n.dom_id).find(".progress").html("unable to compute: "+y)},f.send(o)},N=function(e,r){var a=JSON.parse(e.target.response),t=$("#"+r.dom_id);if("error"in a)b(t.find(".upload-error"),"There was an error attempting to upload the file: "+a.error);else if(r.NUM_CHUNKS===r.CHUNK_INDEX){var n=$('<div class="file-prep-notice"><div class="prep-loader"></div><div class="prep-text">Uploaded file.  Merging.</div></div>');t.find(".progress-display").append(n),n.fadeIn(200,function(){L(r)})}else _(r)},S=function(e,r){e=JSON.data(e),$("#"+r.dom_id).find(".upload-error").html("There was an error attempting to upload the file: "+e.error).show()},w=function(e,r){f.abort(),f=null},L=function(r){f=new XMLHttpRequest;var a=new FormData;a.append("current_index",r.dom_id),a.append("name",r.name),a.append("index",r.NUM_CHUNKS),f.addEventListener("error",function(e){var r=JSON.parse(e.target.response);b("There was an error attempting to upload the file: "+r.error)}),f.addEventListener("load",function(e){var a=JSON.parse(e.target.response);"error"in a?b($("#"+r.dom_id).find(".upload-error"),"There was an error attempting to upload the file: "+a.error):($("#"+r.dom_id).find(".prep-text").html("Merged file.  Updating database."),O(r))}),f.open("POST",e+"includes/fileupload/scripts/ajax-uploader/gallery/merge.php",!0),f.send(a)},O=function(r){f=new XMLHttpRequest;var a=new FormData;a.append("current_index",r.dom_id),a.append("gallery_id",r.gallery_id),f.addEventListener("error",function(e){var r=JSON.parse(e.target.response);b("There was an error attempting to update the database: "+r.error)}),f.addEventListener("load",function(e){var a=JSON.parse(e.target.response);"error"in a?b($("#"+r.dom_id).find(".upload-error"),"There was an error attempting to update the database: "+a.error):($("#"+r.dom_id).find(".prep-loader").css("opacity","0"),$("#"+r.dom_id).find(".prep-text").html("Done!"),u++,document.getElementById("file").files.length>u?h():$("#frm").submit())}),f.open("POST",e+"includes/fileupload/scripts/ajax-uploader/gallery/updateDB.php",!0),f.send(a)},b=function(e,r){e.html(r).show(),e.siblings(".progress-display").find(".progress").addClass("error-progress")},D=function(e,r,a){$("#permalink_error").html(r+" - "+a)};return{addFile:g,prepRequest:h}}();